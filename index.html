<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Logbook</title>
  <link rel="stylesheet" href="css/style.css">
  <!-- <link rel="stylesheet" href="css/font-awesome-min.css"> -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
</head>
<body>

  <form class="search-form">
    <input type="text" class="search" placeholder="Climb or Crag">
    <div class="viewbox">
      <div class="list-container">
        <ul class="suggestions">
          <li>Search for a climb</li>
          <li>...by entering climb or crag name</li>
        </ul>
      </div>
    </div>
  </form>




<script>

// adapted from ajax type ahead thing


// - steps:
// 1 - fetch data (array from endpoint)
// 2 - type into the input box, filter the text by subset which the climb or crag matches
// 3 - click button, show more info about climb or crag
//    - when a climb is selected, data comes from climb ID (inferred by order in data array)
//    - when a crag is selected, data on all climbs I have done at the crag becomes available



// 1 - get data
// 2 - get functions in place
// 3 - hook up to event listeners


// fetch API will return a promise


// things to try out
// - use geolocation - sort by crags closest to me


// ________________________________________________
const endpoint = 'json/mb-logbook.json';

// use fetch API with the endpoint
const climbs = [];

// const prom = fetch(endpoint);
// console.log(prom); // this will return a promise in the console - no data yet, something will come back


// fetch(endpoint).then(blob => console.log(blob));
// data that comes back from fetch does not yet know what type it is
// - in 'proto' in console log, there is a method called 'JSON'
// -> this returns another promise, which you call then on

fetch(endpoint)
    .then(blob => blob.json())
    // .then(data => console.log(data)) // logs out all items in array
    // .then(data => climbs = data) // this results in an array within the array, should climbs be assigned with 'let'
    .then(data => climbs.push(...data)) // use spread operator to spread into climbs





// find matches function
// - gets climb data for matched text, from the original array

// - can only take strings. Integer 999 stumped this before
// - need to convert integers to strings
function findMatches(wordToMatch, climbs) {
  // filter the climbs - a subset of the initial array
  return climbs.filter(entry => {

    // figure out if the climb or crag matches what was searched
    const regex = new RegExp(wordToMatch, 'gi'); // pass 'flags' you want to search (global, insensitive)    

    // this will filter out integers - e.g. the climb 999
    // - regular expressions only work on strings, original array needs to be changed
    if ( entry.climb === parseInt(entry.climb, 10)){
      // convert entry.climb to an integer and return it?
    } else {
      // call match with regex on climb name or crag name
      return entry.climb.match(regex) || entry.crag.match(regex)
    }

  })
}



// calendar function - used twice
// - year is always present. When not set, it is the 2nd item in the array
function calendarHtml(date) {
  const noDate = date.match(/^\?/);
  const split = date.split("/");
  return `
  <span class="calendar${noDate ? " not-set" : ""}">
    <span class="month">${noDate ? `N/A` : `${split[1]}`}</span>
    <span class="day">${noDate ? `N/A` : `${split[0]}`}</span>
    <span class="year">${noDate ? `${split[1]}` : `20${split[2]}`}</span>
  </span>
  `;
}









// display matches function
// - take value of the input field, convert it into matched items from the data
function displayMatches(){

  // call the findMatches function, passing the value to it
  const matchArray = findMatches(this.value, climbs);

  // compose html
  let html = matchArray.map(entry => {
    
    // format the html - highlight the searchterm:
    // 1 - use a regex to match
    // 2 - wrap match in a span - highlight in yellow
    const regex = new RegExp(this.value, 'gi');
    const climbName = entry.climb.replace(regex, `<span class="hl">${this.value}</span>`);
    const cragName = entry.crag.replace(regex, `<span class="hl">${this.value}</span>`);
    
    // add an ID to each climb - for more info on button click
    const climbDate = entry.Date;
    const climbID = climbs.indexOf(entry); // search for entry (item in 'climbs' array)

    // format the date a bit nicer - use calendar function
    // const dateHtml = calendarHtml(climbDate);
    
    return `
      <li class="searched" data-date="${climbDate}" data-id="${climbID}">
        <span class="date">${climbDate}</span>
        <span class="name">${climbName}, ${cragName}</span>
        <span class="more"><i class="fa fa-chevron-right"></i></span>
      </li>
    `;
  }).join(''); // this returns an array (of matches), which need to be joined into a string

  // no results message
  if (html.length < 1) {
    html = `<li class="no-results">No results found. Please try again</li>`;
  }
  // add above html to suggestions
  suggestions.innerHTML = html;

  // find out when input is focused. Want to make climb-info work on 1st click
  // - think of mobile as well, can't do on mousemove only
  // - timeout may be best

}



// get DOM nodes
const searchInput = document.querySelector('.search');
const suggestions = document.querySelector('.suggestions');
const listContainer = document.querySelector('.list-container');

// listen for the change AND keyup events on the input box
searchInput.addEventListener('change', displayMatches);
searchInput.addEventListener('keyup', displayMatches);







// unfocus search input - mouseout for non mobile, timeout (after focus) for mobile
searchInput.addEventListener('mouseout', blurSearch);


// need to unfocus search to allow one click to take you to result
function blurSearch(){
  searchInput.blur();
  // console.log(searchInput);
}







// keep more-info container in view
// - added in container function, results in jerk.
// - probably best to do some absolute positioning
// window.addEventListener('scroll', climbInfoOffset);

// function climbInfoOffset() {
//   const topOffset = window.pageYOffset + 10;
//   listContainer.querySelector('.climb-info').style.marginTop = `${topOffset}px`;
// }





// __________________
// more info buttons

// 1 - get the clicked button
// 2 - get the data associated with it
// 3 - compose html for associated data
// 4 - add html to DOM
// 5 - slide out previous list, slide in new one, with button to slide back
listContainer.addEventListener("click", moreInfo);





// expand object function
// - allow mulitple keys to be assigned to same values - useful for grade colour banding
function expand(obj) {
  const keys = Object.keys(obj);
  for (const key of keys) {
    const subkeys = key.split(/,\s?/);
    const target = obj[key];
    delete obj[key];
    subkeys.forEach(key => { obj[key] = target; })
  }
  return obj;
}


// add faded div if notes section is overflown
function isOverflown(element) {
    return element.scrollHeight > element.clientHeight || element.scrollWidth > element.clientWidth;
}







// switch between list and individual items - ul.suggestions and ul.climb-info
function moreInfo(e) {


  // more button
  // - this does not fire on first click, only second click. Needs to fire on first
  // - may be because input field is still focused. First click de-focuses input field.
  // NOTE: this section will get bloated - look into ways of splitting js up
  if (e.target && e.target.nodeName == "LI" && e.target.classList.contains('searched')) {


    // offset the .climb-info ul with a top margin
    // - required for elements at the bottom of the page / when scrolled down
    const topOffset = window.pageYOffset + 10;


    // get the ID (convert to numeric)
    let ID = e.target.getAttribute('data-id');
    ID = parseInt(ID);
    // get the climb from the array
    const ascent = climbs[ID];
    // get full info
    const date = ascent.Date;
    const name = ascent.climb;
    let grade = ascent.Grade; // need to convert to a string - lower grade american routes are numerical in data
    grade = grade.toString();
    const style = ascent.Style;
    const partners = ascent["Partner(s)"];
    const notes = ascent.Notes;
    const crag = ascent.crag;

    

    
    // _________________
    // grade - most complex parameter of the lot
    // - star count, discipline, grade band colour
    // - grade band dependent upon discipline, and grading system
    // - can't tell discipline from grade for roped climbs, unless in UK system

    // order:
    // uk trad, sport / french, USA, norse, bouldering, winter, ice

    // get the grade - first word of string
    const getGrade = grade.split(" ")[0];
    
    // grade bands object
    const gradeBands = expand({

      "M, D, VD, HVD, S, 1, 2, 3, 4a, 4b, 4c, 5.1, 5.2, 5.3, 5.4, 5.5, 5.6, n1, n2, n3, n4, f1, f2, f2+, f3, f3+, I, II, WI-1, WI-2" : {
        band : ' green'
      },
      "HS, MVS, VS, HVS, 5a, 5b, 5c, 6a, 6a+, 5.7, 5.8, 5.9, 5.10a, 5.10b, 5.10c, n5-, n5, n5+, f4, f4+, III, IV, WI-3, WI-4" : {
        band : ' yellow'
      },
      "E1, E2, E3, 6b, 6b+, 6c, 6c+, 7a, 5.10d, 5.11a, 5.11b, 5.11c, 5.11d, n6-, n6, n6+ f5, f5+, f6A, f6A+, V, VI, WI-5" : {
        band : ' red'
      },
      "E4, E5, E6, E7, E8, E9, E10, E11, E12, 7a+, 7b, 7b+, 7c, 7c+, 8a, 8a+, 8b, 8b+, 8c, 8c+, 9a, 9a+, 9b, 9b+, 9c, 5.12a, 5.12b, 5.12c, 5.12d, 5.13a, 5.13b, 5.13c, 5.13d, 5.14a, n7-, n7, n7+, n8-, n, n8+, f6B, f6B+, f6C, f6c+, f7A, f7A+, f7B, f7B+, f7C, f7C+, f8A, VII, VIII, IX, X, WI-6, WI-7" : {
        band : ' black'
      }
      
    });

    // disciplines object
    // const gradeDisciplines = expand({

    //   "M, D, VD, HVD, S, HS, MVS, VS, HVS, E1, E2, E3, E4, E5, E6, E7, E8, E9, E10, E11, E12" : {
    //     discipline : 'UK trad'
    //   },
    //   "1, 2, 3, 4a, 4b, 4c, 5a, 5b, 5c, 6a, 6a+, 6b, 6b+, 6c, 6c+, 7a, 7a+, 7b, 7b+, 7c, 7c+, 8a, 8a+, 8b, 8b+, 8c, 8c+, 9a, 9a+, 9b, 9b+, 9c" : {
    //     discipline : 'French grade - usually sport'
    //   },
    //   "5.1, 5.2, 5.3, 5.4, 5.5, 5.6, 5.7, 5.8, 5.9, 5.10a, 5.10b, 5.10c, 5.10d, 5.11a, 5.11b, 5.11c, 5.11d, 5.12a, 5.12b, 5.12c, 5.12d, 5.13a, 5.13b, 5.13c, 5.13d, 5.14a" : {
    //     discipline : 'American grade - sport or trad'
    //   }
      
    // });

    // grade - get colour brand from object
    const getColour = gradeBands[getGrade].band;
    // console.log(gradeBands[getGrade].band);
    // console.log(gradeDisciplines[getGrade].discipline);


    // regex for discipline - more efficient than an object
    let discipline;
    if (grade.match(/^W/)) {
      discipline = 'ice';
    }
    else if (grade.match(/^M[0-9]/)) { // M followed by a number
      discipline = 'mixed';
    }
    else if (grade.match(/^f/)) {
      discipline = 'bouldering';
    }
    else if (grade.match(/^I|V(?!S|D)/)) { // I or V if not followed by S or D
      discipline = 'winter';
    }
    else if (grade.match(/^[A-Z]/)) { // starts with a capital letter, comes after the above
      discipline = 'UK trad';
    }
    else if (grade.match(/^[1-9][a-c]/)) { // starts with a number, followed by lowercase letter
      discipline = 'French grade - usually sport';
    }
    else if (grade.match(/^5/)) { // starts with a 5
      discipline = 'American grade - sport or trad';
    }
    else if (grade.match(/^n/)) { // starts with a lowercase n
      discipline = 'Norse grade - sport or trad';
    }

    // stars: swap * for fa-star
    const withStars = grade.replace(/\*/g,"<i class='fa fa-star yellow margin-left'></i>");
    const gradeHtml = `<li class="grade"><i class="fa fa-circle${getColour}"></i>${withStars}</li>`;

    // discipline
    const disciplineHtml = `<li class="discipline"><i class="fa fa-chevron-right"></i>${discipline}</li>`;









    
    
    // _________________
    // style
    // Lead (or solo) + (0/S, _, RP, rpt) = green (note that '_' is a flash)
    // TR + (0/S, _, G/U, RP, rpt) = blue
    // dog, dnf = red

    let success = /(O\/S|_|G\/U|RP|rpt)/;
    success = style.match(success);

    let fail = /(dog|dnf)/;
    fail = style.match(fail);

    // set colour and icon
    let styleColour;
    let styleIcon;
    let styleUnset;
    
    if (fail !== null){
      styleColour = ' red';
      styleIcon = ' fa-close';
    }
    else if (success !== null){
      styleIcon = ' fa-check';
      if (success.input.split(" ")[0] == 'TR' | success.input.split(" ")[0] == '2nd') {
        styleColour = ' blue';
      } else {
        styleColour = ' green';
      }
    }
    else {
      // style has not been set
      styleIcon = ' fa-question';
      styleColour = ' grey';
      styleUnset = ' - style not set';
    }

    // beta: swap _ from data for β
    const withBeta = style.replace(/_/g,"β (flash)");
    const styleHtml = `
    <li class="style${styleColour}">
      <i class="fa${styleIcon}"></i>
      ${withBeta} ${styleUnset !== undefined ? `${styleUnset}` : ""}
    </li>
    `;



    // _________________
    // partner(s)
    // if string contains a comma. Will break if partner's name does not contain a comma for some reason.
    const partnerPlural = partners.includes(',');
    const partnerHtml = `
    ${partners.length > 0 ? `
    <li class="partners">
      <i class="fa fa-user${partnerPlural == false ? "" : "s"}"></i>
      ${partners}
    </li>
    `: ""}
    `;


    // _________________
    // notes
    // - if notes overflow, add an overlay with linear gradient to fade out
    const notesHtml = `
    <li class="notes${notes ? "" : " no-notes"}">
      <i class="fa fa-edit"></i>${notes ? ascent.Notes : "No notes contributed for this climb"}
    </li>`;


    // calendar thing
    const dateHtml = calendarHtml(date);
    
    // add top margin to hold position in the list. Subtract height of searchbar
    const html = `
    <ul class="climb-info"${topOffset > 10 ? ` style="margin-top:${topOffset}px;"` : ""}>
      <li class="title">
        <span class="date back">
          ${dateHtml}
          <i class="fa fa-chevron-left"></i>
        </span>
        ${name}
      </li>
      ${gradeHtml}
      ${disciplineHtml}
      ${styleHtml}
      ${partnerHtml}
      ${notesHtml}
      <li class="crag"><i class="fa fa-map-marker red"></i>${crag}</li>
    </ul>
    `;

    listContainer.insertAdjacentHTML('beforeend', html);
    listContainer.classList.add('slide-left');
    suggestions.classList.add('shadow-off');

    // keep position of climb-info (prevent scroll)
    document.body.classList.add('fixed');


    // overflow fade - need to refine this
    const notesLi = listContainer.querySelector('.notes');
    const notesFade = isOverflown(notesLi);
    if (notesFade == true) {
      notesLi.classList.add('overflow');
    }


  }




    







  
  // back button

  // target back button / icon
  if (e.target && e.target.nodeName == "SPAN" && e.target.classList.contains('back')) {
    
    // slide right
    listContainer.classList.remove('slide-left');
    // add default shadow back to .suggestions
    suggestions.classList.remove('shadow-off');

    // remove climb info ul
    // - take delay value from css (transition on list container = 0.5s)
    // - remove 's'
    let time = window.getComputedStyle(listContainer).transitionDuration.slice(0, -1);
    // - multiply by 1000
    time = parseFloat(time)*1000;
    setTimeout(function(){
      listContainer.querySelector('.climb-info').remove();
      document.body.classList.remove('fixed');
    }, time);


  }


}




</script>




  </body>
</html>
